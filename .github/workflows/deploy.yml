# ═══════════════════════════════════════════════════════════════════════════
# GitHub Pages Deployment for PurpleSky
# ═══════════════════════════════════════════════════════════════════════════
#
# This workflow:
#  1. Installs Rust + wasm-pack for WASM compilation
#  2. Builds the WASM module from wasm/src/lib.rs
#  3. Installs Node.js dependencies
#  4. Builds the Qwik app (static site generation)
#  5. Deploys to GitHub Pages
#
# HOW TO EDIT:
#  - To change the deploy branch, edit the "on.push.branches" trigger
#  - To change the base path, edit VITE_BASE_PATH
#  - To add environment variables, add them to the Build step's env

name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install Rust toolchain for WASM compilation
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      # Install wasm-pack
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # Build WASM module
      - name: Build WASM
        run: cd wasm && wasm-pack build --target web --out-dir ../src/wasm-pkg

      # Set up Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Build the Qwik app (client + SSR with static adapter + lint)
      - name: Build
        run: npx qwik build
        env:
          CI: true
          NODE_OPTIONS: '--max-old-space-size=4096'
          VITE_BASE_PATH: '/purplesky/'

      # Copy PWA assets and ensure SPA fallback
      - name: Prepare dist
        run: |
          # The static adapter generates files in dist/
          # Find where index.html ended up
          echo "=== dist/ ==="
          ls -la dist/ || true
          echo "=== dist/purplesky/ ==="
          ls -la dist/purplesky/ || true

          # If index.html is in dist/purplesky/, we're good
          # If not, check other locations
          if [ -f dist/purplesky/index.html ]; then
            echo "Found index.html in dist/purplesky/"
          elif [ -f dist/index.html ]; then
            echo "Found index.html in dist/"
          else
            echo "::error::No index.html found"
            exit 1
          fi

          # SPA fallback for client-side routing
          if [ -f dist/purplesky/index.html ]; then
            cp dist/purplesky/index.html dist/purplesky/404.html
          fi
          # Root-level redirect
          if [ ! -f dist/index.html ]; then
            echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0;url=/purplesky/"></head><body></body></html>' > dist/index.html
          fi
          cp dist/purplesky/404.html dist/404.html 2>/dev/null || cp dist/purplesky/index.html dist/404.html 2>/dev/null || true

          # Copy PWA assets
          cp public/sw.js dist/purplesky/sw.js 2>/dev/null || true
          cp public/manifest.json dist/purplesky/manifest.json 2>/dev/null || true
          cp public/icon.svg dist/purplesky/icon.svg 2>/dev/null || true
          cp public/client-metadata.json dist/purplesky/client-metadata.json 2>/dev/null || true

      # Upload artifact for GitHub Pages
      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - id: deploy
        uses: actions/deploy-pages@v4
